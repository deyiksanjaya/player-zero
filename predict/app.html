<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Player Zero by Heri Sanjaya</title>

    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#000000"/>
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prediction">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- TTT Layout --- */
        #tictactoe-game {
            position: relative;
            width: 100vw; 
            height: 100vw; 
            /* Menambahkan batas ukuran agar tidak fullscreen di layar besar */
            max-width: 450px;
            max-height: 450px;
            box-sizing: border-box;
            overflow: hidden;
        }
        #slide-wrapper {
            height: 100%;
            display: flex;
            gap: 20px; 
        }
        .slide-container {
            height: 100%;
            width: 100vw;
            flex-shrink: 0;
            box-sizing: border-box;
            background-color: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container.visible { opacity: 1; }
        #prediction-slide.peeking { opacity: 0.1; }
        #board-image { cursor: pointer; }

        /* --- RPS Layout --- */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .is-authenticating {
            /* Efek meredup dihilangkan, namun tetap non-aktif saat otentikasi */
            pointer-events: none;
            cursor: wait;
        }
    </style>
</head>
<body class="w-screen h-screen flex justify-center items-center">

    <!-- Trigger Pengaturan (Tetap tidak terlihat untuk metode sulap) -->
    <div id="settings-trigger" class="absolute top-0 right-0 h-20 w-20 z-50 cursor-pointer"></div>

    <!-- Panel Pengaturan (Modal) -->
    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 text-white rounded-xl shadow-lg w-full max-w-sm p-6 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Pengaturan</h2>
                <button id="close-settings-btn" aria-label="Tutup Pengaturan" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>

            <div>
                <label for="game-mode-select" class="font-medium">Mode Permainan</label>
                <select id="game-mode-select" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="TicTacToe">Tic-Tac-Toe</option>
                    <option value="RockPaperScissors">Rock-Paper-Scissors</option>
                </select>
            </div>

            <!-- Pengaturan Tic-Tac-Toe -->
            <div id="tictactoe-settings" class="space-y-4">
                <div>
                    <label class="font-medium">Mode Input</label>
                    <div class="mt-2 grid grid-cols-2 gap-2">
                        <button id="mode-online-btn" class="p-2 rounded-md transition-colors" aria-label="Pilih Mode Online">Online</button>
                        <button id="mode-manual-btn" class="p-2 rounded-md transition-colors" aria-label="Pilih Mode Manual">Manual</button>
                    </div>
                </div>
                <div>
                    <label for="shortcut-name-input" class="font-medium">Nama Shortcut (iOS)</label>
                    <input type="text" id="shortcut-name-input" placeholder="Contoh: Buka Kamera" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Pengaturan Rock-Paper-Scissors -->
            <div id="rps-settings" class="hidden space-y-4">
                 <div>
                    <label for="rps-rounds-input" class="font-medium">Jumlah Ronde (1-5)</label>
                    <input type="number" id="rps-rounds-input" min="1" max="5" value="5" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="rps-wins-input" class="font-medium">Target Menang</label>
                    <input type="number" id="rps-wins-input" min="0" max="5" value="0" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="rps-loses-input" class="font-medium">Target Kalah</label>
                    <input type="number" id="rps-loses-input" min="0" max="5" value="0" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="rps-draws-input" class="font-medium">Target Seri</label>
                    <input type="number" id="rps-draws-input" min="0" max="5" value="0" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="save-settings-btn" class="px-5 py-2 bg-blue-600 font-semibold rounded-lg hover:bg-blue-700 transition-colors">Simpan & Tutup</button>
            </div>
        </div>
    </div>

    <!-- Kontainer Game Tic-Tac-Toe -->
    <main id="tictactoe-game">
        <div id="peek-board-container">
            <canvas id="peek-canvas"></canvas>
        </div>
        <div id="slide-wrapper">
            <div id="prediction-slide" class="slide-container text-3xl font-bold text-center">
                prediksi saya..
            </div>
            <div class="slide-container text-2xl font-semibold text-center">
                <h2 id="result-text" class="px-8"></h2>
            </div>
            <div class="slide-container">
                <img id="board-image" alt="Papan Permainan Akhir" class="w-full h-full object-contain">
            </div>
        </div>
    </main>

    <!-- Kontainer Game Rock-Paper-Scissors -->
    <div id="rps-game" class="hidden flex flex-col items-center justify-center p-6">
        <div id="rps-image-container" class="flex flex-col flex-wrap justify-center gap-8 is-authenticating">
            <img id="rock" src="/icons/rps/rock.png" alt="Rock" class="w-48 h-48 md:w-64 md:h-64 rounded-lg object-cover shadow-lg invert" onerror="this.onerror=null;this.src='https://placehold.co/256/f1f5f9/334155?text=Rock';">
            <img id="paper" src="/icons/rps/paper.png" alt="Paper" class="w-48 h-48 md:w-64 md:h-64 rounded-lg object-cover shadow-lg invert" onerror="this.onerror=null;this.src='https://placehold.co/256/f1f5f9/334155?text=Paper';">
            <img id="scissors" src="/icons/rps/scissors.png" alt="Scissors" class="w-48 h-48 md:w-64 md:h-64 rounded-lg object-cover shadow-lg invert" onerror="this.onerror=null;this.src='https://placehold.co/256/f1f5f9/334155?text=Scissors';">
        </div>
    </div>
    
    <!-- Overlay Fullscreen untuk RPS -->
    <div id="rps-fullscreen-overlay" class="hidden fixed inset-0 bg-black flex items-center justify-center z-50 p-4">
        <button id="rps-close-fullscreen" class="absolute top-4 right-6 text-gray-200 text-5xl font-bold hover:text-white shadow-lg">&times;</button>
        <img id="rps-fullscreen-image" src="" alt="Fullscreen Choice" class="w-[512px] h-[512px] object-contain rounded-lg invert">
    </div>


    <!-- Notifikasi Update PWA -->
    <div id="update-notification" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-3 rounded-lg shadow-lg">
        Aplikasi diperbarui. Siap digunakan offline.
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsnZdGtP-tY1_vstQOidbM3tS-UktY45Y",
            authDomain: "player-zer0.firebaseapp.com",
            databaseURL: "https://player-zer0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "player-zer0",
            storageBucket: "player-zer0.appspot.com",
            messagingSenderId: "1009636905003",
            appId: "1:1009636905003:web:f3fafd5f5a693440769a6e"
        };
        
        // --- Konstanta ---
        const WINNING_COMBINATIONS = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        const SWIPE_THRESHOLD = 50;
        const DOUBLE_TAP_TIMEOUT = 300;
        const HOLD_TO_PEEK_DELAY = 250;
        const SLIDE_GAP = 20;
        const CLASS_NAMES = {
            HIDDEN: 'hidden',
            VISIBLE: 'visible',
            PEEKING: 'peeking',
            ACTIVE_BUTTON: 'bg-blue-600',
            INACTIVE_BUTTON: 'bg-gray-700'
        };

        // --- Elemen DOM ---
        const dom = {
            // Umum
            settingsTrigger: document.getElementById('settings-trigger'),
            settingsPanel: document.getElementById('settings-panel'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            updateNotification: document.getElementById('update-notification'),
            gameModeSelect: document.getElementById('game-mode-select'),
            // TicTacToe
            tttGame: document.getElementById('tictactoe-game'),
            sliderStage: document.getElementById('tictactoe-game'), // alias for tttGame
            slideWrapper: document.getElementById('slide-wrapper'),
            predictionSlide: document.getElementById('prediction-slide'),
            peekBoardContainer: document.getElementById('peek-board-container'),
            peekCanvas: document.getElementById('peek-canvas'),
            resultText: document.getElementById('result-text'),
            boardImage: document.getElementById('board-image'),
            tttSettings: document.getElementById('tictactoe-settings'),
            modeOnlineBtn: document.getElementById('mode-online-btn'),
            modeManualBtn: document.getElementById('mode-manual-btn'),
            shortcutNameInput: document.getElementById('shortcut-name-input'),
            // RPS
            rpsGame: document.getElementById('rps-game'),
            rpsImageContainer: document.getElementById('rps-image-container'),
            rockImg: document.getElementById('rock'),
            paperImg: document.getElementById('paper'),
            scissorsImg: document.getElementById('scissors'),
            rpsFullscreenOverlay: document.getElementById('rps-fullscreen-overlay'),
            rpsFullscreenImage: document.getElementById('rps-fullscreen-image'),
            rpsCloseFullscreenBtn: document.getElementById('rps-close-fullscreen'),
            rpsSettings: document.getElementById('rps-settings'),
            rpsRoundsInput: document.getElementById('rps-rounds-input'),
            rpsWinsInput: document.getElementById('rps-wins-input'),
            rpsLosesInput: document.getElementById('rps-loses-input'),
            rpsDrawsInput: document.getElementById('rps-draws-input'),
        };

        // --- State Aplikasi ---
        let state = {
            settings: { 
                gameMode: 'TicTacToe',
                tttMode: 'online', 
                tttShortcutName: '',
                rpsRounds: 5,
                rpsWins: 0,
                rpsLoses: 0,
                rpsDraws: 0,
            },
            firebaseUnsubscribe: null,
            isInitialRpsLoad: true,
            // TTT State
            boardData: Array(9).fill(null),
            currentPlayer: 'X',
            gameFinished: false,
            currentSlide: 0,
            swipeGroup: null,
            lastTapTime: 0,
            touchStart: { x: 0, y: 0 },
            slideWidth: 0,
            isDragging: false,
            isPeeking: false,
            peekTimer: null,
            initialTranslate: 0,
            // RPS State
            rpsGamePlan: [],
            rpsCurrentRound: 0,
            rpsCurrentWins: 0,
            rpsCurrentLoses: 0,
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- Fungsi Helper ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- FUNGSI UTAMA PERGANTIAN MODE ---
        function switchGameMode(mode, isInitialLoad = false) {
            state.settings.gameMode = mode;
            if (state.firebaseUnsubscribe) {
                state.firebaseUnsubscribe();
                state.firebaseUnsubscribe = null;
            }

            const isTTT = mode === 'TicTacToe';
            dom.tttGame.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
            dom.rpsGame.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            
            dom.tttSettings.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
            dom.rpsSettings.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            
            if (isTTT) {
                initTicTacToe(isInitialLoad);
            } else {
                initRockPaperScissors();
            }
        }
        
        // --- LOGIKA TIC-TAC-TOE ---
        function initTicTacToe(isInitialLoad) {
            updateSlideDimensions();
            if (isInitialLoad) {
                toggleTttMode(state.settings.tttMode, true);
            } else {
                toggleTttMode(state.settings.tttMode);
            }
        }

        function updateSlideDimensions() {
            state.slideWidth = dom.sliderStage.getBoundingClientRect().width;
            const slides = dom.slideWrapper.querySelectorAll('.slide-container');
            slides.forEach(slide => { slide.style.width = `${state.slideWidth}px`; });
            dom.peekCanvas.width = state.slideWidth;
            dom.peekCanvas.height = state.slideWidth; 
            animateToSlide(state.currentSlide, 0);
        }

        function animateToSlide(slideIndex, duration = 400) {
            state.currentSlide = Math.max(0, Math.min(slideIndex, 2));
            const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
            dom.slideWrapper.style.transition = `transform ${duration}ms ease-in-out`;
            dom.slideWrapper.style.transform = `translateX(-${totalTranslation}px)`;
        }

        function drawOnCanvas(canvas, boardData) {
            const size = canvas.width;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, size, size);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(0, 0, size, size);
            const cellSize = size / 3;
            ctx.strokeStyle = '#CBD5E1'; ctx.lineWidth = 6; ctx.beginPath();
            for (let i = 1; i < 3; i++) {
                ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, size);
                ctx.moveTo(0, i * cellSize); ctx.lineTo(size, i * cellSize);
            }
            ctx.stroke();
            ctx.font = `bold ${cellSize * 0.7}px Poppins`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            boardData.forEach((value, index) => {
                if (!value) return;
                const row = Math.floor(index / 3), col = index % 3;
                const x = col * cellSize + cellSize / 2, y = row * cellSize + cellSize / 2;
                ctx.fillStyle = value === 'X' ? '#EF4444' : '#3B82F6';
                ctx.fillText(value, x, y);
            });
        }

        function resetTttGame() {
            state.boardData.fill(null);
            state.currentPlayer = 'X';
            state.gameFinished = false;
            state.swipeGroup = null;
            dom.resultText.textContent = '';
            dom.boardImage.src = '';
            animateToSlide(0);
        }

        function checkWinner(board) {
            for (const combination of WINNING_COMBINATIONS) {
                const [a, b, c] = combination;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
            }
            return null;
        }

        function handlePostMove() {
            const winner = checkWinner(state.boardData);
            const isFull = state.boardData.every(cell => cell !== null);
            if (winner || isFull) {
                state.gameFinished = true;
                const message = winner ? `saya tahu kalau di akhir, pemenangnya adalah ${winner}` : `saya sudah tau dari awal kalau permainan akan berakhir SERI`;
                dom.resultText.textContent = message;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 512; tempCanvas.height = 512;
                drawOnCanvas(tempCanvas, state.boardData);
                dom.boardImage.src = tempCanvas.toDataURL('image/png');
            } else {
                state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X';
            }
        }
        
        function startPeeking() {
            if (state.gameFinished || state.settings.tttMode !== 'manual') return;
            state.isPeeking = true;
            drawOnCanvas(dom.peekCanvas, state.boardData);
            dom.predictionSlide.classList.add(CLASS_NAMES.PEEKING);
            dom.peekBoardContainer.classList.add(CLASS_NAMES.VISIBLE);
        }

        function stopPeeking() {
            if (!state.isPeeking) return;
            state.isPeeking = false;
            dom.predictionSlide.classList.remove(CLASS_NAMES.PEEKING);
            dom.peekBoardContainer.classList.remove(CLASS_NAMES.VISIBLE);
        }

        function handleManualGesture(deltaX, deltaY) {
            if (Math.abs(deltaX) < SWIPE_THRESHOLD && Math.abs(deltaY) < SWIPE_THRESHOLD) return;
            const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
            const direction = isHorizontal ? (deltaX > 0 ? 'right' : 'left') : (deltaY > 0 ? 'down' : 'up');
            const gestureMap = {
                'col-left': { 'up': 0, 'middle': 3, 'down': 6 },
                'col-right': { 'up': 2, 'middle': 5, 'down': 8 },
                'row-top': { 'left': 0, 'middle': 1, 'right': 2 },
                'row-bottom': { 'left': 6, 'middle': 7, 'right': 8 }
            };
            if (!state.swipeGroup) {
                if (direction === 'up') state.swipeGroup = 'row-top';
                else if (direction === 'down') state.swipeGroup = 'row-bottom';
                else if (direction === 'left') state.swipeGroup = 'col-left';
                else if (direction === 'right') state.swipeGroup = 'col-right';
            } else {
                let cellIndex = -1;
                let secondDirection = 'middle';
                if (state.swipeGroup.startsWith('col')) {
                    if (direction === 'up') secondDirection = 'up';
                    else if (direction === 'down') secondDirection = 'down';
                } else {
                    if (direction === 'left') secondDirection = 'left';
                    else if (direction === 'right') secondDirection = 'right';
                }
                cellIndex = gestureMap[state.swipeGroup]?.[secondDirection];
                if (cellIndex !== undefined && state.boardData[cellIndex] === null) {
                    state.boardData[cellIndex] = state.currentPlayer;
                    handlePostMove();
                }
                state.swipeGroup = null;
            }
        }

        async function copyBase64ToClipboard(imageElement) {
            const base64Data = imageElement.src;
            if (!base64Data || !base64Data.startsWith('data:image/png')) return false;
            try {
                await navigator.clipboard.writeText(base64Data);
                return true;
            } catch (err) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = base64Data;
                    textArea.style.position = 'fixed'; textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return successful;
                } catch (fallbackErr) {
                    return false;
                }
            }
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            state.touchStart.x = touch.clientX;
            state.touchStart.y = touch.clientY;
            state.isDragging = false;
            clearTimeout(state.peekTimer);
            state.peekTimer = setTimeout(startPeeking, HOLD_TO_PEEK_DELAY);
            if (state.gameFinished) {
                dom.slideWrapper.style.transition = 'none';
                const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
                state.initialTranslate = -totalTranslation;
            }
            const now = Date.now();
            if (now - state.lastTapTime <= DOUBLE_TAP_TIMEOUT) {
                handleDoubleTap();
                state.lastTapTime = 0;
            } else {
                state.lastTapTime = now;
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            clearTimeout(state.peekTimer);
            if (state.isPeeking) stopPeeking();
            if (!state.gameFinished) return;
            const currentX = e.touches[0].clientX;
            const diffX = currentX - state.touchStart.x;
            if (Math.abs(diffX) > 10) state.isDragging = true;
            if (state.isDragging) {
                dom.slideWrapper.style.transform = `translateX(${state.initialTranslate + diffX}px)`;
            }
        }

        async function handleTouchEnd(e) {
            clearTimeout(state.peekTimer);
            if (state.isPeeking) { stopPeeking(); return; }
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const deltaX = endX - state.touchStart.x;
            const deltaY = endY - state.touchStart.y;
            
            if (state.gameFinished) {
                if (state.isDragging) {
                    if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
                        if (deltaX < 0) animateToSlide(state.currentSlide + 1);
                        else animateToSlide(state.currentSlide - 1);
                    } else {
                        animateToSlide(state.currentSlide);
                    }
                } else if (e.target === dom.boardImage) {
                    await handleBoardClick();
                }
            } else if (state.settings.tttMode === 'manual' && !state.isDragging) {
                handleManualGesture(deltaX, deltaY);
            }
            state.isDragging = false;
        }
        
        function handleDoubleTap() {
            if (state.gameFinished || state.settings.tttMode !== 'manual') return;
            const middleCell = 4;
            if (state.boardData[middleCell] === null) {
                state.boardData[middleCell] = state.currentPlayer;
                handlePostMove();
            }
        }
        
        async function handleBoardClick() {
            if (!state.gameFinished) return;
            const isSuccess = await copyBase64ToClipboard(dom.boardImage);
            if (isSuccess && state.settings.tttShortcutName) {
                setTimeout(() => {
                    window.location.href = `shortcuts://run-shortcut?name=${encodeURIComponent(state.settings.tttShortcutName)}`;
                }, 100);
            }
        }
        
        function toggleTttMode(newMode, isInitialLoad = false) {
            state.settings.tttMode = newMode;
            if (!isInitialLoad) resetTttGame();
            if (newMode === 'online') {
                initializeTttFirebaseListener();
            } else if (state.firebaseUnsubscribe) {
                 state.firebaseUnsubscribe();
                 state.firebaseUnsubscribe = null;
            }
            
            const isOnline = newMode === 'online';
            dom.modeOnlineBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, isOnline);
            dom.modeOnlineBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, !isOnline);
            dom.modeManualBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, !isOnline);
            dom.modeManualBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, isOnline);
        }

        function initializeTttFirebaseListener() {
            if (state.firebaseUnsubscribe) {
                state.firebaseUnsubscribe();
                state.firebaseUnsubscribe = null;
            }
            const gameRef = ref(db, 'magic-game-state');
            state.firebaseUnsubscribe = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists() || state.gameFinished) return;
                const gameState = snapshot.val();
                if (gameState && gameState.board) {
                    for (let i = 0; i < 9; i++) state.boardData[i] = gameState.board[i] || null;
                    if (checkWinner(state.boardData) || state.boardData.every(cell => cell !== null)) {
                        handlePostMove();
                    }
                }
            });
        }
        
        // --- LOGIKA ROCK-PAPER-SCISSORS ---
        function initRockPaperScissors() {
            resetRpsGame();
            generateRpsPlan();
            initializeRpsFirebaseListener();
        }
        
        function resetRpsGame() {
            state.isInitialRpsLoad = true;
            state.rpsCurrentRound = 0;
            state.rpsCurrentWins = 0;
            state.rpsCurrentLoses = 0;
            state.rpsGamePlan = [];
            closeRpsFullscreen();
        }

        function generateRpsPlan() {
            const plan = [];
            for (let i = 0; i < state.settings.rpsWins; i++) plan.push('win');
            for (let i = 0; i < state.settings.rpsLoses; i++) plan.push('lose');
            for (let i = 0; i < state.settings.rpsDraws; i++) plan.push('draw');
            
            const remainingRounds = state.settings.rpsRounds - plan.length;
            for (let i = 0; i < remainingRounds; i++) plan.push('draw'); // Sisa ronde dijadikan seri
            
            // Shuffle the plan
            for (let i = plan.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [plan[i], plan[j]] = [plan[j], plan[i]];
            }
            state.rpsGamePlan = plan;
        }

        function initializeRpsFirebaseListener() {
            if (state.firebaseUnsubscribe) {
                state.firebaseUnsubscribe();
                state.firebaseUnsubscribe = null;
            }
            const gameRef = ref(db, 'rock-paper-scissors');
            state.firebaseUnsubscribe = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    return;
                }
                
                if (state.isInitialRpsLoad) {
                    state.isInitialRpsLoad = false;
                    return;
                }
                
                const data = snapshot.val();
                const opponentChoice = data.userChoice;
                if (opponentChoice) {
                    handleRpsMagic(opponentChoice);
                }
            });
        }

        function handleRpsMagic(opponentChoice) {
            if (state.rpsCurrentRound >= state.settings.rpsRounds) return;

            const desiredOutcome = state.rpsGamePlan[state.rpsCurrentRound];
            let myChoice;

            if (desiredOutcome === 'win') {
                if (opponentChoice === 'rock') myChoice = 'paper';
                else if (opponentChoice === 'paper') myChoice = 'scissors';
                else myChoice = 'rock';
                state.rpsCurrentWins++;
            } else if (desiredOutcome === 'lose') {
                if (opponentChoice === 'rock') myChoice = 'scissors';
                else if (opponentChoice === 'paper') myChoice = 'rock';
                else myChoice = 'paper';
                state.rpsCurrentLoses++;
            } else { // draw
                myChoice = opponentChoice;
            }
            
            const myImageElement = dom[`${myChoice}Img`];
            if(myImageElement) {
                showRpsFullscreen(myImageElement.src);
            }
            
            state.rpsCurrentRound++;

            // Timeout otomatis dihilangkan. Tampilan akan tetap ada sampai ditutup manual.
        }

        function showRpsFullscreen(imageSrc) {
            dom.rpsFullscreenImage.src = imageSrc;
            dom.rpsFullscreenOverlay.classList.remove('hidden');
        }

        function closeRpsFullscreen() {
            dom.rpsFullscreenOverlay.classList.add('hidden');
            // Cek apakah permainan sudah selesai saat overlay ditutup
            if (state.rpsCurrentRound >= state.settings.rpsRounds) {
                 console.log("RPS Game Selesai!");
                 // Reset lagi untuk game berikutnya
                 generateRpsPlan();
                 state.rpsCurrentRound = 0;
                 state.rpsCurrentWins = 0;
                 state.rpsCurrentLoses = 0;
            }
        }

        // --- PENGATURAN & PENYIMPANAN ---
        function openSettings() { dom.settingsPanel.classList.remove(CLASS_NAMES.HIDDEN); }
        function closeSettings() { dom.settingsPanel.classList.add(CLASS_NAMES.HIDDEN); }

        function saveSettings() {
            // Simpan pengaturan umum
            state.settings.gameMode = dom.gameModeSelect.value;
            
            // Simpan pengaturan TTT
            state.settings.tttShortcutName = dom.shortcutNameInput.value.trim();
            // tttMode sudah diupdate via toggleTttMode

            // Simpan pengaturan RPS
            let rounds = parseInt(dom.rpsRoundsInput.value) || 1;
            rounds = Math.max(1, Math.min(5, rounds)); // Clamp between 1-5
            let wins = parseInt(dom.rpsWinsInput.value) || 0;
            let loses = parseInt(dom.rpsLosesInput.value) || 0;
            let draws = parseInt(dom.rpsDrawsInput.value) || 0;

            if (wins + loses + draws > rounds) {
                // Menggunakan alert() karena ini adalah feedback kritis untuk pengguna
                alert("Jumlah target Menang, Kalah, & Seri tidak boleh melebihi Jumlah Ronde.");
                return;
            }
            dom.rpsRoundsInput.value = rounds;
            state.settings.rpsRounds = rounds;
            state.settings.rpsWins = Math.max(0, Math.min(rounds, wins));
            state.settings.rpsLoses = Math.max(0, Math.min(rounds, loses));
            state.settings.rpsDraws = Math.max(0, Math.min(rounds, draws));
            dom.rpsWinsInput.value = state.settings.rpsWins;
            dom.rpsLosesInput.value = state.settings.rpsLoses;
            dom.rpsDrawsInput.value = state.settings.rpsDraws;

            localStorage.setItem('playerZeroSettings', JSON.stringify(state.settings));
            closeSettings();
            
            // Re-initialize game mode in case settings changed
            switchGameMode(state.settings.gameMode);
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('playerZeroSettings');
            if (savedSettings) {
                const defaultSettings = { 
                    gameMode: 'TicTacToe', tttMode: 'online', tttShortcutName: '',
                    rpsRounds: 5, rpsWins: 0, rpsLoses: 0, rpsDraws: 0
                };
                state.settings = { ...defaultSettings, ...JSON.parse(savedSettings) };
            }
            // Update UI from loaded settings
            dom.gameModeSelect.value = state.settings.gameMode;
            dom.shortcutNameInput.value = state.settings.tttShortcutName || '';
            dom.rpsRoundsInput.value = state.settings.rpsRounds;
            dom.rpsWinsInput.value = state.settings.rpsWins;
            dom.rpsLosesInput.value = state.settings.rpsLoses;
            dom.rpsDrawsInput.value = state.settings.rpsDraws;
            
            // Panggil switchGameMode setelah memastikan UI pengaturan TTT/RPS terlihat/tersembunyi dengan benar
            const isTTT = state.settings.gameMode === 'TicTacToe';
            dom.tttSettings.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
            dom.rpsSettings.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            switchGameMode(state.settings.gameMode, true);
        }
        
        // --- PWA & Inisialisasi ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker terdaftar'))
                    .catch(err => console.log('Pendaftaran Service Worker gagal:', err));
            }
        }
        
        function showUpdateNotification() {
            if (dom.updateNotification) {
                dom.updateNotification.classList.remove(CLASS_NAMES.HIDDEN);
                setTimeout(() => {
                    dom.updateNotification.classList.add(CLASS_NAMES.HIDDEN);
                }, 4000);
            }
        }

        function listenForServiceWorkerUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'CACHE_UPDATED') {
                        showUpdateNotification();
                    }
                });
            }
        }

        function setupEventListeners() {
            dom.sliderStage.addEventListener('touchstart', handleTouchStart, { passive: false });
            dom.sliderStage.addEventListener('touchmove', handleTouchMove, { passive: false });
            dom.sliderStage.addEventListener('touchend', handleTouchEnd);
            window.addEventListener('resize', debounce(updateSlideDimensions, 250));
            
            dom.settingsTrigger.addEventListener('click', openSettings);
            dom.closeSettingsBtn.addEventListener('click', closeSettings);
            dom.saveSettingsBtn.addEventListener('click', saveSettings);

            dom.gameModeSelect.addEventListener('change', (e) => {
                const isTTT = e.target.value === 'TicTacToe';
                dom.tttSettings.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
                dom.rpsSettings.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            });

            dom.modeOnlineBtn.addEventListener('click', () => toggleTttMode('online'));
            dom.modeManualBtn.addEventListener('click', () => toggleTttMode('manual'));

            dom.rpsCloseFullscreenBtn.addEventListener('click', closeRpsFullscreen);

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSettings();
            });
        }
        
        function init() {
            onAuthStateChanged(auth, user => {
                if (!user) {
                    signInAnonymously(auth).catch(err => console.error("Gagal login anonim:", err));
                }
            });
            loadSettings();
            setupEventListeners();
            registerServiceWorker();
            listenForServiceWorkerUpdates();
        }

        init();
    </script>
</body>
</html>
