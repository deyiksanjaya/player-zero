<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Player Zero by Heri Sanjaya</title>

    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#000000"/>
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prediction">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- TTT Layout --- */
        #tictactoe-game {
            position: relative;
            width: 100vw; 
            height: 100vw; 
            max-width: 450px;
            max-height: 450px;
            box-sizing: border-box;
            overflow: hidden;
        }
        #slide-wrapper {
            height: 100%;
            display: flex;
            gap: 20px; 
        }
        .slide-container {
            height: 100%;
            width: 100vw;
            flex-shrink: 0;
            box-sizing: border-box;
            background-color: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container.visible { opacity: 1; }
        #prediction-slide.peeking { opacity: 0.1; }
        #board-image { cursor: pointer; }

        /* --- RPS Layout & Visual Cues --- */
        #rps-image-container img {
            box-shadow: 0 0 15px 4px rgba(139, 92, 246, 0.5); /* Default Glow */
            transition: box-shadow 0.4s ease-in-out, transform 0.2s ease;
            cursor: pointer;
        }
        #rps-image-container img.is-cue {
             box-shadow: 0 0 8px 2px rgba(139, 92, 246, 0.2); /* Dimmed Glow for the cue */
        }
        #rps-image-container img:hover {
            transform: scale(1.05);
        }
        .is-authenticating {
            pointer-events: none;
            cursor: wait;
        }
    </style>
</head>
<body class="w-screen h-screen flex justify-center items-center">

    <!-- Trigger Pengaturan (Tetap tidak terlihat untuk metode sulap) -->
    <div id="settings-trigger" class="absolute top-0 right-0 h-20 w-20 z-50 cursor-pointer"></div>

    <!-- Panel Pengaturan (Modal) -->
    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 text-white rounded-xl shadow-lg w-full max-w-sm p-6 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Pengaturan</h2>
                <button id="close-settings-btn" aria-label="Tutup Pengaturan" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>

            <div>
                <label for="game-mode-select" class="font-medium">Mode Permainan</label>
                <select id="game-mode-select" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="TicTacToe">Tic-Tac-Toe</option>
                    <option value="RockPaperScissors">Rock-Paper-Scissors</option>
                </select>
            </div>

            <!-- Pengaturan Tic-Tac-Toe -->
            <div id="tictactoe-settings" class="space-y-4">
                <div>
                    <label class="font-medium">Mode Input</label>
                    <div class="mt-2 grid grid-cols-2 gap-2">
                        <button id="mode-online-btn" class="p-2 rounded-md transition-colors" aria-label="Pilih Mode Online">Online</button>
                        <button id="mode-manual-btn" class="p-2 rounded-md transition-colors" aria-label="Pilih Mode Manual">Manual</button>
                    </div>
                </div>
                <div>
                    <label for="shortcut-name-input" class="font-medium">Nama Shortcut (iOS)</label>
                    <input type="text" id="shortcut-name-input" placeholder="Contoh: Buka Kamera" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Pengaturan Rock-Paper-Scissors -->
            <div id="rps-settings" class="hidden space-y-4">
                 <div>
                    <label class="font-medium">Gaya Permainan</label>
                     <div class="mt-2 grid grid-cols-2 gap-2">
                        <button id="rps-mode-magician-btn" class="p-2 rounded-md transition-colors">Magician First</button>
                        <button id="rps-mode-spectator-btn" class="p-2 rounded-md transition-colors">Spectator First</button>
                    </div>
                 </div>
                 <div>
                    <label for="rps-rounds-input" class="font-medium">Jumlah Ronde (1-5)</label>
                    <input type="number" id="rps-rounds-input" min="1" max="5" value="5" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="rps-wins-input" class="font-medium">Target Menang</label>
                    <input type="number" id="rps-wins-input" min="0" max="5" value="0" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="rps-loses-input" class="font-medium">Target Kalah</label>
                    <input type="number" id="rps-loses-input" min="0" max="5" value="0" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
                 <div>
                    <label for="rps-draws-input" class="font-medium">Target Seri</label>
                    <input type="number" id="rps-draws-input" min="0" max="5" value="0" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="save-settings-btn" class="px-5 py-2 bg-blue-600 font-semibold rounded-lg hover:bg-blue-700 transition-colors">Simpan & Tutup</button>
            </div>
        </div>
    </div>

    <!-- Kontainer Game Tic-Tac-Toe -->
    <main id="tictactoe-game">
        <div id="peek-board-container">
            <canvas id="peek-canvas"></canvas>
        </div>
        <div id="slide-wrapper">
            <div id="prediction-slide" class="slide-container text-3xl font-bold text-center">
                prediksi saya..
            </div>
            <div class="slide-container text-2xl font-semibold text-center">
                <h2 id="result-text" class="px-8"></h2>
            </div>
            <div class="slide-container">
                <img id="board-image" alt="Papan Permainan Akhir" class="w-full h-full object-contain">
            </div>
        </div>
    </main>

    <!-- Kontainer Game Rock-Paper-Scissors -->
    <div id="rps-game" class="hidden flex flex-col items-center justify-center p-6">
        <div id="rps-image-container" class="flex flex-col flex-wrap justify-center gap-8">
            <img id="rock" src="/icons/rps/rock.png" alt="Rock" class="w-48 h-48 md:w-64 md:h-64 rounded-lg object-cover invert" onerror="this.onerror=null;this.src='https://placehold.co/256/f1f5f9/334155?text=Rock';">
            <img id="paper" src="/icons/rps/paper.png" alt="Paper" class="w-48 h-48 md:w-64 md:h-64 rounded-lg object-cover invert" onerror="this.onerror=null;this.src='https://placehold.co/256/f1f5f9/334155?text=Paper';">
            <img id="scissors" src="/icons/rps/scissors.png" alt="Scissors" class="w-48 h-48 md:w-64 md:h-64 rounded-lg object-cover invert" onerror="this.onerror=null;this.src='https://placehold.co/256/f1f5f9/334155?text=Scissors';">
        </div>
    </div>
    
    <!-- Overlay Fullscreen untuk RPS -->
    <div id="rps-fullscreen-overlay" class="hidden fixed inset-0 bg-black flex items-center justify-center z-50 p-4">
        <button id="rps-close-fullscreen" class="absolute top-4 right-6 text-gray-200 text-5xl font-bold hover:text-white shadow-lg">&times;</button>
        <img id="rps-fullscreen-image" src="" alt="Fullscreen Choice" class="w-[512px] h-[512px] object-contain rounded-lg invert">
    </div>


    <!-- Notifikasi Update PWA -->
    <div id="update-notification" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-3 rounded-lg shadow-lg">
        Aplikasi diperbarui. Siap digunakan offline.
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsnZdGtP-tY1_vstQOidbM3tS-UktY45Y",
            authDomain: "player-zer0.firebaseapp.com",
            databaseURL: "https://player-zer0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "player-zer0",
            storageBucket: "player-zer0.appspot.com",
            messagingSenderId: "1009636905003",
            appId: "1:1009636905003:web:f3fafd5f5a693440769a6e"
        };
        
        // --- Konstanta ---
        const WINNING_COMBINATIONS = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        const SWIPE_THRESHOLD = 50;
        const DOUBLE_TAP_TIMEOUT = 300;
        const HOLD_TO_PEEK_DELAY = 250;
        const SLIDE_GAP = 20;
        const CLASS_NAMES = {
            HIDDEN: 'hidden',
            VISIBLE: 'visible',
            PEEKING: 'peeking',
            ACTIVE_BUTTON: 'bg-blue-600',
            INACTIVE_BUTTON: 'bg-gray-700',
            IS_CUE: 'is-cue', // Class untuk isyarat visual
        };

        // --- Elemen DOM ---
        const dom = {
            // Umum
            settingsTrigger: document.getElementById('settings-trigger'),
            settingsPanel: document.getElementById('settings-panel'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            updateNotification: document.getElementById('update-notification'),
            gameModeSelect: document.getElementById('game-mode-select'),
            // TicTacToe
            tttGame: document.getElementById('tictactoe-game'),
            sliderStage: document.getElementById('tictactoe-game'), // alias
            slideWrapper: document.getElementById('slide-wrapper'),
            predictionSlide: document.getElementById('prediction-slide'),
            peekBoardContainer: document.getElementById('peek-board-container'),
            peekCanvas: document.getElementById('peek-canvas'),
            resultText: document.getElementById('result-text'),
            boardImage: document.getElementById('board-image'),
            tttSettings: document.getElementById('tictactoe-settings'),
            modeOnlineBtn: document.getElementById('mode-online-btn'),
            modeManualBtn: document.getElementById('mode-manual-btn'),
            shortcutNameInput: document.getElementById('shortcut-name-input'),
            // RPS
            rpsGame: document.getElementById('rps-game'),
            rpsImageContainer: document.getElementById('rps-image-container'),
            rockImg: document.getElementById('rock'),
            paperImg: document.getElementById('paper'),
            scissorsImg: document.getElementById('scissors'),
            rpsFullscreenOverlay: document.getElementById('rps-fullscreen-overlay'),
            rpsFullscreenImage: document.getElementById('rps-fullscreen-image'),
            rpsCloseFullscreenBtn: document.getElementById('rps-close-fullscreen'),
            rpsSettings: document.getElementById('rps-settings'),
            rpsModeMagicianBtn: document.getElementById('rps-mode-magician-btn'),
            rpsModeSpectatorBtn: document.getElementById('rps-mode-spectator-btn'),
            rpsRoundsInput: document.getElementById('rps-rounds-input'),
            rpsWinsInput: document.getElementById('rps-wins-input'),
            rpsLosesInput: document.getElementById('rps-loses-input'),
            rpsDrawsInput: document.getElementById('rps-draws-input'),
        };

        // --- State Aplikasi ---
        let state = {
            settings: { 
                gameMode: 'TicTacToe',
                tttMode: 'online', 
                tttShortcutName: '',
                rpsPlayMode: 'magicianFirst', // Mode baru
                rpsRounds: 5,
                rpsWins: 0,
                rpsLoses: 0,
                rpsDraws: 0,
            },
            firebaseUnsubscribe: null,
            isInitialRpsLoad: true,
            // TTT State
            boardData: Array(9).fill(null),
            currentPlayer: 'X',
            gameFinished: false,
            currentSlide: 0,
            swipeGroup: null,
            lastTapTime: 0,
            touchStart: { x: 0, y: 0 },
            slideWidth: 0,
            isDragging: false,
            isPeeking: false,
            peekTimer: null,
            initialTranslate: 0,
            // RPS State
            rpsGamePlan: [],
            rpsCurrentRound: 0,
            rpsCorrectChoiceForSpectator: null, // Pilihan benar untuk mode Spectator
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- Fungsi Helper ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- FUNGSI UTAMA PERGANTIAN MODE ---
        function switchGameMode(mode, isInitialLoad = false) {
            state.settings.gameMode = mode;
            if (state.firebaseUnsubscribe) { state.firebaseUnsubscribe(); state.firebaseUnsubscribe = null; }
            const isTTT = mode === 'TicTacToe';
            dom.tttGame.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
            dom.rpsGame.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            dom.tttSettings.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
            dom.rpsSettings.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            if (isTTT) initTicTacToe(isInitialLoad);
            else initRockPaperScissors(isInitialLoad);
        }
        
        // --- LOGIKA TIC-TAC-TOE ---
        function initTicTacToe(isInitialLoad) {
            updateSlideDimensions();
            toggleTttMode(state.settings.tttMode, isInitialLoad);
        }
        function updateSlideDimensions() {
            state.slideWidth = dom.sliderStage.getBoundingClientRect().width;
            const slides = dom.slideWrapper.querySelectorAll('.slide-container');
            slides.forEach(slide => { slide.style.width = `${state.slideWidth}px`; });
            dom.peekCanvas.width = state.slideWidth;
            dom.peekCanvas.height = state.slideWidth; 
            animateToSlide(state.currentSlide, 0);
        }
        function animateToSlide(slideIndex, duration = 400) {
            state.currentSlide = Math.max(0, Math.min(slideIndex, 2));
            const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
            dom.slideWrapper.style.transition = `transform ${duration}ms ease-in-out`;
            dom.slideWrapper.style.transform = `translateX(-${totalTranslation}px)`;
        }
        function drawOnCanvas(canvas, boardData) {
            const size = canvas.width;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, size, size); ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; ctx.fillRect(0, 0, size, size);
            const cellSize = size / 3;
            ctx.strokeStyle = '#CBD5E1'; ctx.lineWidth = 6; ctx.beginPath();
            for (let i = 1; i < 3; i++) {
                ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, size);
                ctx.moveTo(0, i * cellSize); ctx.lineTo(size, i * cellSize);
            }
            ctx.stroke();
            ctx.font = `bold ${cellSize * 0.7}px Poppins`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            boardData.forEach((value, index) => {
                if (!value) return;
                const row = Math.floor(index / 3), col = index % 3;
                const x = col * cellSize + cellSize / 2, y = row * cellSize + cellSize / 2;
                ctx.fillStyle = value === 'X' ? '#EF4444' : '#3B82F6';
                ctx.fillText(value, x, y);
            });
        }
        function resetTttGame() {
            state.boardData.fill(null); state.currentPlayer = 'X'; state.gameFinished = false; state.swipeGroup = null;
            dom.resultText.textContent = ''; dom.boardImage.src = ''; animateToSlide(0);
        }
        function checkWinner(board) {
            for (const c of WINNING_COMBINATIONS) if (board[c[0]] && board[c[0]] === board[c[1]] && board[c[0]] === board[c[2]]) return board[c[0]];
            return null;
        }
        function handlePostMove() {
            const winner = checkWinner(state.boardData);
            const isFull = state.boardData.every(cell => cell !== null);
            if (winner || isFull) {
                state.gameFinished = true;
                dom.resultText.textContent = winner ? `saya tahu kalau di akhir, pemenangnya adalah ${winner}` : `saya sudah tau dari awal kalau permainan akan berakhir SERI`;
                const tempCanvas = document.createElement('canvas'); tempCanvas.width = 512; tempCanvas.height = 512;
                drawOnCanvas(tempCanvas, state.boardData); dom.boardImage.src = tempCanvas.toDataURL('image/png');
            } else { state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X'; }
        }
        function startPeeking() {
            if (state.gameFinished || state.settings.tttMode !== 'manual') return;
            state.isPeeking = true; drawOnCanvas(dom.peekCanvas, state.boardData);
            dom.predictionSlide.classList.add(CLASS_NAMES.PEEKING); dom.peekBoardContainer.classList.add(CLASS_NAMES.VISIBLE);
        }
        function stopPeeking() {
            if (!state.isPeeking) return;
            state.isPeeking = false; dom.predictionSlide.classList.remove(CLASS_NAMES.PEEKING); dom.peekBoardContainer.classList.remove(CLASS_NAMES.VISIBLE);
        }
        function handleManualGesture(deltaX, deltaY) {
            if (Math.abs(deltaX) < SWIPE_THRESHOLD && Math.abs(deltaY) < SWIPE_THRESHOLD) return;
            const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
            const direction = isHorizontal ? (deltaX > 0 ? 'right' : 'left') : (deltaY > 0 ? 'down' : 'up');
            const gestureMap = { 'col-left': { 'up': 0, 'middle': 3, 'down': 6 }, 'col-right': { 'up': 2, 'middle': 5, 'down': 8 }, 'row-top': { 'left': 0, 'middle': 1, 'right': 2 }, 'row-bottom': { 'left': 6, 'middle': 7, 'right': 8 } };
            if (!state.swipeGroup) {
                if (direction === 'up') state.swipeGroup = 'row-top'; else if (direction === 'down') state.swipeGroup = 'row-bottom';
                else if (direction === 'left') state.swipeGroup = 'col-left'; else if (direction === 'right') state.swipeGroup = 'col-right';
            } else {
                let cellIndex = -1; let secondDirection = 'middle';
                if (state.swipeGroup.startsWith('col')) { if (direction === 'up') secondDirection = 'up'; else if (direction === 'down') secondDirection = 'down'; } 
                else { if (direction === 'left') secondDirection = 'left'; else if (direction === 'right') secondDirection = 'right'; }
                cellIndex = gestureMap[state.swipeGroup]?.[secondDirection];
                if (cellIndex !== undefined && state.boardData[cellIndex] === null) { state.boardData[cellIndex] = state.currentPlayer; handlePostMove(); }
                state.swipeGroup = null;
            }
        }
        async function copyBase64ToClipboard(img) { /* ... implementation ... */ }
        function handleTouchStart(e) { /* ... implementation ... */ }
        function handleTouchMove(e) { /* ... implementation ... */ }
        async function handleTouchEnd(e) { /* ... implementation ... */ }
        function handleDoubleTap() { /* ... implementation ... */ }
        async function handleBoardClick() { /* ... implementation ... */ }
        function toggleTttMode(newMode, isInitialLoad = false) {
            state.settings.tttMode = newMode; if (!isInitialLoad) resetTttGame();
            if (newMode === 'online') initializeTttFirebaseListener();
            else if (state.firebaseUnsubscribe) { state.firebaseUnsubscribe(); state.firebaseUnsubscribe = null; }
            const isOnline = newMode === 'online';
            dom.modeOnlineBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, isOnline); dom.modeOnlineBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, !isOnline);
            dom.modeManualBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, !isOnline); dom.modeManualBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, isOnline);
        }
        function initializeTttFirebaseListener() {
            if (state.firebaseUnsubscribe) { state.firebaseUnsubscribe(); state.firebaseUnsubscribe = null; }
            const gameRef = ref(db, 'magic-game-state');
            state.firebaseUnsubscribe = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists() || state.gameFinished) return;
                const gameState = snapshot.val();
                if (gameState && gameState.board) {
                    for (let i = 0; i < 9; i++) state.boardData[i] = gameState.board[i] || null;
                    if (checkWinner(state.boardData) || state.boardData.every(cell => cell !== null)) handlePostMove();
                }
            });
        }
        
        // --- LOGIKA ROCK-PAPER-SCISSORS ---
        function initRockPaperScissors(isInitialLoad) {
            resetRpsGame();
            generateRpsPlan();
            initializeRpsFirebaseListener();
            if(isInitialLoad) toggleRpsPlayMode(state.settings.rpsPlayMode, true);
        }
        function resetRpsGame() {
            state.isInitialRpsLoad = true; state.rpsCurrentRound = 0; state.rpsGamePlan = [];
            state.rpsCorrectChoiceForSpectator = null;
            dom.rockImg.classList.remove(CLASS_NAMES.IS_CUE);
            dom.paperImg.classList.remove(CLASS_NAMES.IS_CUE);
            dom.scissorsImg.classList.remove(CLASS_NAMES.IS_CUE);
            closeRpsFullscreen();
        }
        function generateRpsPlan() {
            const plan = [];
            for (let i = 0; i < state.settings.rpsWins; i++) plan.push('win');
            for (let i = 0; i < state.settings.rpsLoses; i++) plan.push('lose');
            for (let i = 0; i < state.settings.rpsDraws; i++) plan.push('draw');
            const remaining = state.settings.rpsRounds - plan.length;
            for (let i = 0; i < remaining; i++) plan.push('draw');
            for (let i = plan.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [plan[i], plan[j]] = [plan[j], plan[i]]; }
            state.rpsGamePlan = plan;
        }
        function initializeRpsFirebaseListener() {
            if (state.firebaseUnsubscribe) { state.firebaseUnsubscribe(); state.firebaseUnsubscribe = null; }
            const gameRef = ref(db, 'rock-paper-scissors');
            state.firebaseUnsubscribe = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists() || state.isInitialRpsLoad) { state.isInitialRpsLoad = false; return; }
                const opponentChoice = snapshot.val().userChoice;
                if (opponentChoice) handleRpsMagic(opponentChoice);
            });
        }
        function handleRpsMagic(opponentChoice) {
            if (state.rpsCurrentRound >= state.settings.rpsRounds) return;
            const desiredOutcome = state.rpsGamePlan[state.rpsCurrentRound];
            let myChoice;
            if (desiredOutcome === 'win') myChoice = { rock: 'paper', paper: 'scissors', scissors: 'rock' }[opponentChoice];
            else if (desiredOutcome === 'lose') myChoice = { rock: 'scissors', paper: 'rock', scissors: 'paper' }[opponentChoice];
            else myChoice = opponentChoice;
            
            if (state.settings.rpsPlayMode === 'magicianFirst') {
                showRpsFullscreen(dom[`${myChoice}Img`].src);
                state.rpsCurrentRound++;
            } else { // spectatorFirst
                state.rpsCorrectChoiceForSpectator = myChoice;
                dom.rockImg.classList.remove(CLASS_NAMES.IS_CUE);
                dom.paperImg.classList.remove(CLASS_NAMES.IS_CUE);
                dom.scissorsImg.classList.remove(CLASS_NAMES.IS_CUE);
                dom[`${myChoice}Img`].classList.add(CLASS_NAMES.IS_CUE);
            }
        }
        function handleSpectatorChoice(chosen) {
            if (state.settings.rpsPlayMode !== 'spectatorFirst' || chosen !== state.rpsCorrectChoiceForSpectator) return;
            
            showRpsFullscreen(dom[`${chosen}Img`].src);
            state.rpsCurrentRound++;
            state.rpsCorrectChoiceForSpectator = null;
            dom.rockImg.classList.remove(CLASS_NAMES.IS_CUE);
            dom.paperImg.classList.remove(CLASS_NAMES.IS_CUE);
            dom.scissorsImg.classList.remove(CLASS_NAMES.IS_CUE);
        }
        function showRpsFullscreen(src) {
            dom.rpsFullscreenImage.src = src; dom.rpsFullscreenOverlay.classList.remove('hidden');
        }
        function closeRpsFullscreen() {
            dom.rpsFullscreenOverlay.classList.add('hidden');
            if (state.rpsCurrentRound >= state.settings.rpsRounds) {
                console.log("RPS Game Selesai!");
                resetRpsGame(); generateRpsPlan();
            }
        }
        function toggleRpsPlayMode(newMode, isInitialLoad = false) {
            state.settings.rpsPlayMode = newMode;
            if(!isInitialLoad) resetRpsGame();
            const isMagician = newMode === 'magicianFirst';
            dom.rpsModeMagicianBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, isMagician);
            dom.rpsModeMagicianBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, !isMagician);
            dom.rpsModeSpectatorBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, !isMagician);
            dom.rpsModeSpectatorBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, isMagician);
        }

        // --- PENGATURAN & PENYIMPANAN ---
        function openSettings() { dom.settingsPanel.classList.remove(CLASS_NAMES.HIDDEN); }
        function closeSettings() { dom.settingsPanel.classList.add(CLASS_NAMES.HIDDEN); }
        function saveSettings() {
            state.settings.gameMode = dom.gameModeSelect.value;
            state.settings.tttShortcutName = dom.shortcutNameInput.value.trim();
            
            let rounds = parseInt(dom.rpsRoundsInput.value) || 1;
            let wins = parseInt(dom.rpsWinsInput.value) || 0;
            let loses = parseInt(dom.rpsLosesInput.value) || 0;
            let draws = parseInt(dom.rpsDrawsInput.value) || 0;
            if (wins + loses + draws > rounds) {
                alert("Jumlah target Menang, Kalah, & Seri tidak boleh melebihi Jumlah Ronde."); return;
            }
            state.settings.rpsRounds = rounds; state.settings.rpsWins = wins; state.settings.rpsLoses = loses; state.settings.rpsDraws = draws;
            dom.rpsRoundsInput.value = rounds; dom.rpsWinsInput.value = wins; dom.rpsLosesInput.value = loses; dom.rpsDrawsInput.value = draws;

            localStorage.setItem('playerZeroSettings', JSON.stringify(state.settings));
            closeSettings();
            switchGameMode(state.settings.gameMode);
        }
        function loadSettings() {
            const saved = localStorage.getItem('playerZeroSettings');
            if (saved) {
                const defaults = { gameMode: 'TicTacToe', tttMode: 'online', tttShortcutName: '', rpsPlayMode: 'magicianFirst', rpsRounds: 5, rpsWins: 0, rpsLoses: 0, rpsDraws: 0 };
                state.settings = { ...defaults, ...JSON.parse(saved) };
            }
            dom.gameModeSelect.value = state.settings.gameMode;
            dom.shortcutNameInput.value = state.settings.tttShortcutName || '';
            dom.rpsRoundsInput.value = state.settings.rpsRounds; dom.rpsWinsInput.value = state.settings.rpsWins;
            dom.rpsLosesInput.value = state.settings.rpsLoses; dom.rpsDrawsInput.value = state.settings.rpsDraws;
            
            const isTTT = state.settings.gameMode === 'TicTacToe';
            dom.tttSettings.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
            dom.rpsSettings.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            switchGameMode(state.settings.gameMode, true);
        }
        
        // --- PWA & Inisialisasi ---
        function registerServiceWorker() { /* ... implementation ... */ }
        function showUpdateNotification() { /* ... implementation ... */ }
        function listenForServiceWorkerUpdates() { /* ... implementation ... */ }
        function setupEventListeners() {
            dom.sliderStage.addEventListener('touchstart', handleTouchStart, { passive: false });
            dom.sliderStage.addEventListener('touchmove', handleTouchMove, { passive: false });
            dom.sliderStage.addEventListener('touchend', handleTouchEnd);
            window.addEventListener('resize', debounce(updateSlideDimensions, 250));
            
            dom.settingsTrigger.addEventListener('click', openSettings);
            dom.closeSettingsBtn.addEventListener('click', closeSettings);
            dom.saveSettingsBtn.addEventListener('click', saveSettings);
            dom.gameModeSelect.addEventListener('change', (e) => {
                const isTTT = e.target.value === 'TicTacToe';
                dom.tttSettings.classList.toggle(CLASS_NAMES.HIDDEN, !isTTT);
                dom.rpsSettings.classList.toggle(CLASS_NAMES.HIDDEN, isTTT);
            });
            dom.modeOnlineBtn.addEventListener('click', () => toggleTttMode('online'));
            dom.modeManualBtn.addEventListener('click', () => toggleTttMode('manual'));

            // RPS Listeners
            dom.rpsModeMagicianBtn.addEventListener('click', () => toggleRpsPlayMode('magicianFirst'));
            dom.rpsModeSpectatorBtn.addEventListener('click', () => toggleRpsPlayMode('spectatorFirst'));
            dom.rockImg.addEventListener('click', () => handleSpectatorChoice('rock'));
            dom.paperImg.addEventListener('click', () => handleSpectatorChoice('paper'));
            dom.scissorsImg.addEventListener('click', () => handleSpectatorChoice('scissors'));
            dom.rpsCloseFullscreenBtn.addEventListener('click', closeRpsFullscreen);

            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSettings(); });
        }
        
        function init() {
            onAuthStateChanged(auth, user => { if (!user) signInAnonymously(auth); });
            loadSettings();
            setupEventListeners();
            registerServiceWorker();
            listenForServiceWorkerUpdates();
        }
        init();
    </script>
</body>
</html>