<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Player Zero by Heri Sanjaya</title>
    
    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#000000"/>
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prediction">
    <link rel="apple-touch-icon" href="images/icons/icon-180x180.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        html, body {
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            -webkit-user-select: none;
            user-select: none; 
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }
        #slider-stage {
            width: 100vw;
            height: 100vw;
            max-height: 100vh;
            max-width: 100vw;
            overflow: hidden;
            position: relative;
        }
        #slide-wrapper {
            display: flex;
            height: 100%;
            gap: 20px;
        }
        .slide-container {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0; 
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container.visible {
            opacity: 1;
        }
        #prediction-slide.peeking {
            opacity: 0.1;
        }
    </style>
</head>
<body class="w-screen h-screen flex justify-center items-center">

    <!-- Trigger Pengaturan -->
    <div id="settings-trigger" class="absolute top-0 right-0 h-20 w-20 z-50 cursor-pointer"></div>

    <!-- Panel Pengaturan (Modal) -->
    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 text-white rounded-xl shadow-lg w-full max-w-sm p-6 space-y-4">
            <h2 class="text-xl font-bold mb-4">Pengaturan</h2>
            <div>
                <label class="font-medium">Mode Input</label>
                <div class="mt-2 grid grid-cols-2 gap-2">
                    <button id="mode-online-btn" class="p-2 rounded-md transition-colors">Online</button>
                    <button id="mode-manual-btn" class="p-2 rounded-md transition-colors">Manual</button>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="save-settings-btn" class="px-5 py-2 bg-blue-600 font-semibold rounded-lg hover:bg-blue-700 transition-colors">Tutup</button>
            </div>
        </div>
    </div>
    
    <main id="slider-stage">
      <div id="peek-board-container">
          <canvas id="peek-canvas"></canvas>
      </div>
      <div id="slide-wrapper">
          <div id="prediction-slide" class="slide-container text-3xl font-bold text-center">
              prediksi saya..
          </div>
          <div class="slide-container text-2xl font-semibold text-center">
              <h2 id="result-text" class="px-8"></h2>
          </div>
          <div class="slide-container">
              <img id="board-image" src="" alt="Papan Permainan Akhir" class="w-full h-full object-contain">
          </div>
      </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDsnZdGtP-tY1_vstQOidbM3tS-UktY45Y",
          authDomain: "player-zer0.firebaseapp.com",
          databaseURL: "https://player-zer0-default-rtdb.asia-southeast1.firebasedatabase.app", 
          projectId: "player-zer0",
          storageBucket: "player-zer0.firebasestorage.app",
          messagingSenderId: "1009636905003",
          appId: "1:1009636905003:web:f3fafd5f5a693440769a6e"
        };

        const WINNING_COMBINATIONS = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        const SWIPE_THRESHOLD = 50;
        const DOUBLE_TAP_TIMEOUT = 300;
        const HOLD_TO_PEEK_DELAY = 250;
        const SLIDE_GAP = 20;

        const dom = {
            sliderStage: document.getElementById('slider-stage'),
            slideWrapper: document.getElementById('slide-wrapper'),
            predictionSlide: document.getElementById('prediction-slide'),
            peekBoardContainer: document.getElementById('peek-board-container'),
            peekCanvas: document.getElementById('peek-canvas'),
            resultText: document.getElementById('result-text'),
            boardImage: document.getElementById('board-image'),
            settingsTrigger: document.getElementById('settings-trigger'),
            settingsPanel: document.getElementById('settings-panel'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            modeOnlineBtn: document.getElementById('mode-online-btn'),
            modeManualBtn: document.getElementById('mode-manual-btn'),
        };

        let state = {
            settings: { mode: 'online' },
            boardData: Array(9).fill(null),
            currentPlayer: 'X',
            gameFinished: false,
            currentSlide: 0,
            swipeGroup: null,
            lastTapTime: 0,
            touchStart: { x: 0, y: 0 },
            firebaseUnsubscribe: null,
            slideWidth: 0,
            isDragging: false,
            isPeeking: false,
            peekTimer: null,
            initialTranslate: 0,
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        function init() {
            loadSettings();
            setupEventListeners();
            updateSlideDimensions();
        }

        function updateSlideDimensions() {
            state.slideWidth = dom.sliderStage.getBoundingClientRect().width;
            const slides = document.querySelectorAll('.slide-container');
            slides.forEach(slide => {
                slide.style.width = `${state.slideWidth}px`;
            });
            dom.peekCanvas.width = state.slideWidth;
            dom.peekCanvas.height = state.slideWidth;
            animateToSlide(state.currentSlide, 0);
        }

        function animateToSlide(slideIndex, duration = 400) {
            state.currentSlide = Math.max(0, Math.min(slideIndex, 2));
            const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
            dom.slideWrapper.style.transition = `transform ${duration}ms ease-in-out`;
            dom.slideWrapper.style.transform = `translateX(-${totalTranslation}px)`;
        }

        // PERBAIKAN: Fungsi ini sekarang HANYA menggambar di atas elemen <canvas>
        function drawOnCanvas(canvas, boardData) {
            const size = canvas.width;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, size, size);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(0, 0, size, size);
            const cellSize = size / 3;
            ctx.strokeStyle = '#CBD5E1'; ctx.lineWidth = 6; ctx.beginPath();
            for (let i = 1; i < 3; i++) {
                ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, size);
                ctx.moveTo(0, i * cellSize); ctx.lineTo(size, i * cellSize);
            }
            ctx.stroke();
            ctx.font = `bold ${cellSize * 0.7}px Poppins`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            boardData.forEach((value, index) => {
                if (!value) return;
                const row = Math.floor(index / 3), col = index % 3;
                const x = col * cellSize + cellSize / 2, y = row * cellSize + cellSize / 2;
                ctx.fillStyle = value === 'X' ? '#EF4444' : '#3B82F6';
                ctx.fillText(value, x, y);
            });
        }

        function resetGame() {
            state.boardData.fill(null);
            state.currentPlayer = 'X';
            state.gameFinished = false;
            state.swipeGroup = null;
            dom.resultText.textContent = '';
            dom.boardImage.src = ''; // Kosongkan sumber gambar
            animateToSlide(0);
        }

        function checkWinner(board) {
            for (const combination of WINNING_COMBINATIONS) {
                const [a, b, c] = combination;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a]; 
            }
            return null;
        }

        function handlePostMove() {
            const winner = checkWinner(state.boardData);
            const isFull = state.boardData.every(cell => cell !== null);
            if (winner || isFull) {
                state.gameFinished = true;
                const message = winner ? `saya tahu kalau di akhir, pemenangnya adalah ${winner}` : `permainan berakhir seri`;
                dom.resultText.textContent = message;

                // PERBAIKAN: Logika yang benar untuk membuat gambar
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 512; // Resolusi tinggi
                tempCanvas.height = 512;
                drawOnCanvas(tempCanvas, state.boardData); // Gambar di kanvas sementara
                dom.boardImage.src = tempCanvas.toDataURL('image/png'); // Setel hasilnya ke <img>
            } else {
                state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X';
            }
        }
        
        function startPeeking() {
            if (state.gameFinished || state.settings.mode !== 'manual') return;
            state.isPeeking = true;
            drawOnCanvas(dom.peekCanvas, state.boardData); // Menggunakan fungsi gambar yang sama
            dom.predictionSlide.classList.add('peeking');
            dom.peekBoardContainer.classList.add('visible');
        }

        function stopPeeking() {
            if (!state.isPeeking) return;
            state.isPeeking = false;
            dom.predictionSlide.classList.remove('peeking');
            dom.peekBoardContainer.classList.remove('visible');
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            state.touchStart.x = touch.clientX;
            state.touchStart.y = touch.clientY;
            state.isDragging = false;
            
            clearTimeout(state.peekTimer);
            state.peekTimer = setTimeout(startPeeking, HOLD_TO_PEEK_DELAY);

            if (state.gameFinished) {
                dom.slideWrapper.style.transition = 'none';
                const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
                state.initialTranslate = -totalTranslation;
            }
            
            const now = Date.now();
            if (now - state.lastTapTime <= DOUBLE_TAP_TIMEOUT) {
                handleDoubleTap();
                state.lastTapTime = 0;
            } else {
                state.lastTapTime = now;
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            clearTimeout(state.peekTimer);
            if (state.isPeeking) stopPeeking();

            if (!state.gameFinished) return;
            
            const currentX = e.touches[0].clientX;
            const diffX = currentX - state.touchStart.x;
            if (Math.abs(diffX) > 10) state.isDragging = true;
            if (state.isDragging) {
                dom.slideWrapper.style.transform = `translateX(${state.initialTranslate + diffX}px)`;
            }
        }

        function handleTouchEnd(e) {
            clearTimeout(state.peekTimer);
            if (state.isPeeking) {
                stopPeeking();
                return;
            }

            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const deltaX = endX - state.touchStart.x;
            const deltaY = endY - state.touchStart.y;

            if (state.gameFinished) {
                if (state.isDragging) {
                    if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
                        if (deltaX < 0) animateToSlide(state.currentSlide + 1);
                        else animateToSlide(state.currentSlide - 1);
                    } else {
                        animateToSlide(state.currentSlide);
                    }
                }
            } else if (state.settings.mode === 'manual' && !state.isDragging) {
                handleManualGesture(deltaX, deltaY);
            }
            state.isDragging = false;
        }

        function handleManualGesture(deltaX, deltaY) {
            if (Math.abs(deltaX) < SWIPE_THRESHOLD && Math.abs(deltaY) < SWIPE_THRESHOLD) return;
            const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
            let direction = isHorizontal ? (deltaX > 0 ? 'right' : 'left') : (deltaY > 0 ? 'down' : 'up');

            if (!state.swipeGroup) {
                if (direction === 'up') state.swipeGroup = 'row-top';
                else if (direction === 'down') state.swipeGroup = 'row-bottom';
                else if (direction === 'left') state.swipeGroup = 'col-left';
                else if (direction === 'right') state.swipeGroup = 'col-right';
            } else {
                let cellIndex = -1;
                if (state.swipeGroup.startsWith('col')) {
                    if (direction === 'up') cellIndex = (state.swipeGroup === 'col-left' ? 0 : 2);
                    else if (direction === 'down') cellIndex = (state.swipeGroup === 'col-left' ? 6 : 8);
                    else cellIndex = (state.swipeGroup === 'col-left' ? 3 : 5);
                } else {
                    if (direction === 'left') cellIndex = (state.swipeGroup === 'row-top' ? 0 : 6);
                    else if (direction === 'right') cellIndex = (state.swipeGroup === 'row-top' ? 2 : 8);
                    else cellIndex = (state.swipeGroup === 'row-top' ? 1 : 7);
                }
                if (cellIndex !== -1 && state.boardData[cellIndex] === null) {
                    state.boardData[cellIndex] = state.currentPlayer;
                    handlePostMove();
                }
                state.swipeGroup = null;
            }
        }
        
        function handleDoubleTap() {
            if (state.gameFinished || state.settings.mode !== 'manual') return;
            const middleCell = 4;
            if (state.boardData[middleCell] === null) {
                state.boardData[middleCell] = state.currentPlayer;
                handlePostMove();
            }
        }
        
        function toggleMode(newMode) {
            state.settings.mode = newMode;
            resetGame();
            if (newMode === 'online') initializeFirebaseListener();
            else if (state.firebaseUnsubscribe) state.firebaseUnsubscribe();
            const isOnline = newMode === 'online';
            dom.modeOnlineBtn.classList.toggle('bg-blue-600', isOnline);
            dom.modeOnlineBtn.classList.toggle('bg-gray-700', !isOnline);
            dom.modeManualBtn.classList.toggle('bg-blue-600', !isOnline);
            dom.modeManualBtn.classList.toggle('bg-gray-700', isOnline);
        }
        
        function initializeFirebaseListener() {
            if (state.firebaseUnsubscribe) state.firebaseUnsubscribe();
            const gameRef = ref(db, 'magic-game-state');
            state.firebaseUnsubscribe = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists() || state.gameFinished) return;
                const gameState = snapshot.val();
                if (gameState && gameState.board) {
                    for (let i = 0; i < 9; i++) state.boardData[i] = gameState.board[i] || null;
                    if (checkWinner(state.boardData) || state.boardData.every(cell => cell !== null)) {
                        handlePostMove();
                    }
                }
            });
        }
        
        function setupEventListeners() {
            const stage = dom.sliderStage;
            stage.addEventListener('touchstart', handleTouchStart, { passive: false });
            stage.addEventListener('touchmove', handleTouchMove, { passive: false });
            stage.addEventListener('touchend', handleTouchEnd);
            window.addEventListener('resize', updateSlideDimensions);
            dom.settingsTrigger.addEventListener('click', () => dom.settingsPanel.classList.remove('hidden'));
            dom.saveSettingsBtn.addEventListener('click', () => {
                localStorage.setItem('playerZeroSettings', JSON.stringify(state.settings));
                dom.settingsPanel.classList.add('hidden');
            });
            dom.modeOnlineBtn.addEventListener('click', () => toggleMode('online'));
            dom.modeManualBtn.addEventListener('click', () => toggleMode('manual'));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('playerZeroSettings');
            if (savedSettings) state.settings = JSON.parse(savedSettings);
            toggleMode(state.settings.mode);
        }

        init();
    </script>
</body>
</html>