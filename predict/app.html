<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Player Zero by Heri Sanjaya</title>

    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#000000"/>
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prediction">
    <link rel="apple-touch-icon" href="images/icons/icon-180x180.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* CSS tetap sama, sudah cukup baik */
        html, body {
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }
        #slider-stage {
            width: 100vmin;
            height: 100vmin;
            overflow: hidden;
            position: relative;
        }
        #slide-wrapper {
            display: flex;
            height: 100%;
            gap: 20px;
        }
        .slide-container {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #peek-board-container.visible {
            opacity: 1;
        }
        #prediction-slide.peeking {
            opacity: 0.1;
        }
        #board-image {
            cursor: pointer;
        }
        #update-notification {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
    </style>
</head>
<body class="w-screen h-screen flex justify-center items-center">

    <!-- Trigger Pengaturan (Tetap tidak terlihat untuk metode sulap) -->
    <div id="settings-trigger" class="absolute top-0 right-0 h-20 w-20 z-50 cursor-pointer"></div>

    <!-- Panel Pengaturan (Modal) -->
    <div id="settings-panel" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 text-white rounded-xl shadow-lg w-full max-w-sm p-6 space-y-4">
            <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold">Pengaturan</h2>
                 <button id="close-settings-btn" aria-label="Tutup Pengaturan" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div>
                <label class="font-medium">Mode Input</label>
                <div class="mt-2 grid grid-cols-2 gap-2">
                    <button id="mode-online-btn" class="p-2 rounded-md transition-colors" aria-label="Pilih Mode Online">Online</button>
                    <button id="mode-manual-btn" class="p-2 rounded-md transition-colors" aria-label="Pilih Mode Manual">Manual</button>
                </div>
            </div>
            <div>
                <label for="shortcut-name-input" class="font-medium">Nama Shortcut (iOS)</label>
                <input type="text" id="shortcut-name-input" placeholder="Contoh: Buka Kamera" class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="mt-6 flex justify-end">
                <button id="save-settings-btn" class="px-5 py-2 bg-blue-600 font-semibold rounded-lg hover:bg-blue-700 transition-colors">Simpan & Tutup</button>
            </div>
        </div>
    </div>

    <main id="slider-stage">
      <div id="peek-board-container">
          <canvas id="peek-canvas"></canvas>
      </div>
      <div id="slide-wrapper">
          <div id="prediction-slide" class="slide-container text-3xl font-bold text-center">
              prediksi saya..
          </div>
          <div class="slide-container text-2xl font-semibold text-center">
              <h2 id="result-text" class="px-8"></h2>
          </div>
          <div class="slide-container">
              <img id="board-image" alt="Papan Permainan Akhir" class="w-full h-full object-contain">
          </div>
      </div>
    </main>

    <!-- Notifikasi Update PWA -->
    <div id="update-notification" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-3 rounded-lg shadow-lg">
        Aplikasi diperbarui. Siap digunakan offline.
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- Konfigurasi Firebase ---
        // Untuk pemakaian pribadi, konfigurasi di sisi klien seperti ini tidak masalah.
        const firebaseConfig = {
            apiKey: "AIzaSyDsnZdGtP-tY1_vstQOidbM3tS-UktY45Y",
            authDomain: "player-zer0.firebaseapp.com",
            databaseURL: "https://player-zer0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "player-zer0",
            storageBucket: "player-zer0.appspot.com",
            messagingSenderId: "1009636905003",
            appId: "1:1009636905003:web:f3fafd5f5a693440769a6e"
        };

        // --- Konstanta ---
        const WINNING_COMBINATIONS = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
        const SWIPE_THRESHOLD = 50;
        const DOUBLE_TAP_TIMEOUT = 300;
        const HOLD_TO_PEEK_DELAY = 250;
        const SLIDE_GAP = 20;
        const CLASS_NAMES = {
            HIDDEN: 'hidden',
            VISIBLE: 'visible',
            PEEKING: 'peeking',
            ACTIVE_BUTTON: 'bg-blue-600',
            INACTIVE_BUTTON: 'bg-gray-700'
        };

        // --- Elemen DOM ---
        const dom = {
            sliderStage: document.getElementById('slider-stage'),
            slideWrapper: document.getElementById('slide-wrapper'),
            predictionSlide: document.getElementById('prediction-slide'),
            peekBoardContainer: document.getElementById('peek-board-container'),
            peekCanvas: document.getElementById('peek-canvas'),
            resultText: document.getElementById('result-text'),
            boardImage: document.getElementById('board-image'),
            settingsTrigger: document.getElementById('settings-trigger'),
            settingsPanel: document.getElementById('settings-panel'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            modeOnlineBtn: document.getElementById('mode-online-btn'),
            modeManualBtn: document.getElementById('mode-manual-btn'),
            shortcutNameInput: document.getElementById('shortcut-name-input'),
            updateNotification: document.getElementById('update-notification')
        };

        // --- State Aplikasi ---
        let state = {
            settings: { mode: 'online', shortcutName: '' },
            boardData: Array(9).fill(null),
            currentPlayer: 'X',
            gameFinished: false,
            currentSlide: 0,
            swipeGroup: null,
            lastTapTime: 0,
            touchStart: { x: 0, y: 0 },
            firebaseUnsubscribe: null,
            slideWidth: 0,
            isDragging: false,
            isPeeking: false,
            peekTimer: null,
            initialTranslate: 0,
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Fungsi Helper ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Fungsi Inti Aplikasi ---

        function updateSlideDimensions() {
            state.slideWidth = dom.sliderStage.getBoundingClientRect().width;
            const slides = document.querySelectorAll('.slide-container');
            slides.forEach(slide => { slide.style.width = `${state.slideWidth}px`; });
            dom.peekCanvas.width = state.slideWidth;
            dom.peekCanvas.height = state.slideWidth;
            animateToSlide(state.currentSlide, 0);
        }

        function animateToSlide(slideIndex, duration = 400) {
            state.currentSlide = Math.max(0, Math.min(slideIndex, 2));
            const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
            dom.slideWrapper.style.transition = `transform ${duration}ms ease-in-out`;
            dom.slideWrapper.style.transform = `translateX(-${totalTranslation}px)`;
        }

        function drawOnCanvas(canvas, boardData) {
            const size = canvas.width;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, size, size);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(0, 0, size, size);
            const cellSize = size / 3;
            ctx.strokeStyle = '#CBD5E1'; ctx.lineWidth = 6; ctx.beginPath();
            for (let i = 1; i < 3; i++) {
                ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, size);
                ctx.moveTo(0, i * cellSize); ctx.lineTo(size, i * cellSize);
            }
            ctx.stroke();
            ctx.font = `bold ${cellSize * 0.7}px Poppins`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            boardData.forEach((value, index) => {
                if (!value) return;
                const row = Math.floor(index / 3), col = index % 3;
                const x = col * cellSize + cellSize / 2, y = row * cellSize + cellSize / 2;
                ctx.fillStyle = value === 'X' ? '#EF4444' : '#3B82F6';
                ctx.fillText(value, x, y);
            });
        }

        function resetGame() {
            state.boardData.fill(null);
            state.currentPlayer = 'X';
            state.gameFinished = false;
            state.swipeGroup = null;
            dom.resultText.textContent = '';
            dom.boardImage.src = '';
            animateToSlide(0);
        }

        function checkWinner(board) {
            for (const combination of WINNING_COMBINATIONS) {
                const [a, b, c] = combination;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
            }
            return null;
        }

        function handlePostMove() {
            const winner = checkWinner(state.boardData);
            const isFull = state.boardData.every(cell => cell !== null);
            if (winner || isFull) {
                state.gameFinished = true;
                const message = winner ? `saya tahu kalau di akhir, pemenangnya adalah ${winner}` : `permainan berakhir seri`;
                dom.resultText.textContent = message;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 512;
                tempCanvas.height = 512;
                drawOnCanvas(tempCanvas, state.boardData);
                dom.boardImage.src = tempCanvas.toDataURL('image/png');
            } else {
                state.currentPlayer = state.currentPlayer === 'X' ? 'O' : 'X';
            }
        }
        
        function startPeeking() {
            if (state.gameFinished || state.settings.mode !== 'manual') return;
            state.isPeeking = true;
            drawOnCanvas(dom.peekCanvas, state.boardData);
            dom.predictionSlide.classList.add(CLASS_NAMES.PEEKING);
            dom.peekBoardContainer.classList.add(CLASS_NAMES.VISIBLE);
        }

        function stopPeeking() {
            if (!state.isPeeking) return;
            state.isPeeking = false;
            dom.predictionSlide.classList.remove(CLASS_NAMES.PEEKING);
            dom.peekBoardContainer.classList.remove(CLASS_NAMES.VISIBLE);
        }

        // --- UPGRADE: Logika Gesture Manual yang Lebih Andal ---
        function handleManualGesture(deltaX, deltaY) {
            if (Math.abs(deltaX) < SWIPE_THRESHOLD && Math.abs(deltaY) < SWIPE_THRESHOLD) return;

            const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
            const direction = isHorizontal ? (deltaX > 0 ? 'right' : 'left') : (deltaY > 0 ? 'down' : 'up');

            const gestureMap = {
                'col-left': { 'up': 0, 'middle': 3, 'down': 6 },
                'col-right': { 'up': 2, 'middle': 5, 'down': 8 },
                'row-top': { 'left': 0, 'middle': 1, 'right': 2 },
                'row-bottom': { 'left': 6, 'middle': 7, 'right': 8 }
            };

            if (!state.swipeGroup) {
                if (direction === 'up') state.swipeGroup = 'row-top';
                else if (direction === 'down') state.swipeGroup = 'row-bottom';
                else if (direction === 'left') state.swipeGroup = 'col-left';
                else if (direction === 'right') state.swipeGroup = 'col-right';
            } else {
                let cellIndex = -1;
                let secondDirection = 'middle';

                if (state.swipeGroup.startsWith('col')) {
                    if (direction === 'up') secondDirection = 'up';
                    else if (direction === 'down') secondDirection = 'down';
                } else {
                    if (direction === 'left') secondDirection = 'left';
                    else if (direction === 'right') secondDirection = 'right';
                }

                cellIndex = gestureMap[state.swipeGroup]?.[secondDirection];

                if (cellIndex !== undefined && state.boardData[cellIndex] === null) {
                    state.boardData[cellIndex] = state.currentPlayer;
                    handlePostMove();
                }
                
                state.swipeGroup = null;
            }
        }

        // --- DIKEMBALIKAN: Fungsi Salin Teks Base64 ---
        async function copyBase64ToClipboard(imageElement) {
            const base64Data = imageElement.src;
            if (!base64Data || !base64Data.startsWith('data:image/png')) {
                console.error("Data gambar tidak valid untuk disalin.");
                return false;
            }
            try {
                await navigator.clipboard.writeText(base64Data);
                console.log("Teks Base64 berhasil disalin!");
                return true;
            } catch (err) {
                console.warn("Metode salin modern gagal, mencoba fallback:", err);
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = base64Data;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return successful;
                } catch (fallbackErr) {
                    console.error("Fallback copy juga gagal:", fallbackErr);
                    return false;
                }
            }
        }
        
        // --- Event Handlers ---
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            state.touchStart.x = touch.clientX;
            state.touchStart.y = touch.clientY;
            state.isDragging = false;
            clearTimeout(state.peekTimer);
            state.peekTimer = setTimeout(startPeeking, HOLD_TO_PEEK_DELAY);
            if (state.gameFinished) {
                dom.slideWrapper.style.transition = 'none';
                const totalTranslation = (state.slideWidth * state.currentSlide) + (SLIDE_GAP * state.currentSlide);
                state.initialTranslate = -totalTranslation;
            }
            const now = Date.now();
            if (now - state.lastTapTime <= DOUBLE_TAP_TIMEOUT) {
                handleDoubleTap();
                state.lastTapTime = 0;
            } else {
                state.lastTapTime = now;
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            clearTimeout(state.peekTimer);
            if (state.isPeeking) stopPeeking();
            if (!state.gameFinished) return;
            const currentX = e.touches[0].clientX;
            const diffX = currentX - state.touchStart.x;
            if (Math.abs(diffX) > 10) state.isDragging = true;
            if (state.isDragging) {
                dom.slideWrapper.style.transform = `translateX(${state.initialTranslate + diffX}px)`;
            }
        }

        async function handleTouchEnd(e) {
            clearTimeout(state.peekTimer);
            if (state.isPeeking) {
                stopPeeking();
                return;
            }
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const deltaX = endX - state.touchStart.x;
            const deltaY = endY - state.touchStart.y;
            
            if (state.gameFinished) {
                if (state.isDragging) {
                    if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
                        if (deltaX < 0) animateToSlide(state.currentSlide + 1);
                        else animateToSlide(state.currentSlide - 1);
                    } else {
                        animateToSlide(state.currentSlide);
                    }
                } else if (e.target === dom.boardImage) {
                    await handleBoardClick();
                }
            } else if (state.settings.mode === 'manual' && !state.isDragging) {
                handleManualGesture(deltaX, deltaY);
            }
            state.isDragging = false;
        }
        
        function handleDoubleTap() {
            if (state.gameFinished || state.settings.mode !== 'manual') return;
            const middleCell = 4;
            if (state.boardData[middleCell] === null) {
                state.boardData[middleCell] = state.currentPlayer;
                handlePostMove();
            }
        }
        
        async function handleBoardClick() {
            if (!state.gameFinished) return;
            const isSuccess = await copyBase64ToClipboard(dom.boardImage);
            if (isSuccess && state.settings.shortcutName) {
                setTimeout(() => {
                    window.location.href = `shortcuts://run-shortcut?name=${encodeURIComponent(state.settings.shortcutName)}`;
                }, 100);
            }
        }
        
        // --- Pengaturan & Mode ---
        function toggleMode(newMode) {
            state.settings.mode = newMode;
            resetGame();
            if (newMode === 'online') initializeFirebaseListener();
            else if (state.firebaseUnsubscribe) state.firebaseUnsubscribe();
            
            const isOnline = newMode === 'online';
            dom.modeOnlineBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, isOnline);
            dom.modeOnlineBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, !isOnline);
            dom.modeManualBtn.classList.toggle(CLASS_NAMES.ACTIVE_BUTTON, !isOnline);
            dom.modeManualBtn.classList.toggle(CLASS_NAMES.INACTIVE_BUTTON, isOnline);
            dom.shortcutNameInput.value = state.settings.shortcutName || '';
        }

        function initializeFirebaseListener() {
            if (state.firebaseUnsubscribe) state.firebaseUnsubscribe();
            const gameRef = ref(db, 'magic-game-state');
            state.firebaseUnsubscribe = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists() || state.gameFinished) return;
                const gameState = snapshot.val();
                if (gameState && gameState.board) {
                    for (let i = 0; i < 9; i++) state.boardData[i] = gameState.board[i] || null;
                    if (checkWinner(state.boardData) || state.boardData.every(cell => cell !== null)) {
                        handlePostMove();
                    }
                }
            });
        }
        
        function openSettings() { dom.settingsPanel.classList.remove(CLASS_NAMES.HIDDEN); }
        function closeSettings() { dom.settingsPanel.classList.add(CLASS_NAMES.HIDDEN); }

        function saveSettings() {
            state.settings.shortcutName = dom.shortcutNameInput.value.trim();
            localStorage.setItem('playerZeroSettings', JSON.stringify(state.settings));
            closeSettings();
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('playerZeroSettings');
            if (savedSettings) {
                const defaultSettings = { mode: 'online', shortcutName: '' };
                state.settings = { ...defaultSettings, ...JSON.parse(savedSettings) };
            }
            toggleMode(state.settings.mode);
        }

        // --- Pendaftaran Service Worker & Trigger Update ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('Service Worker berhasil didaftarkan:', registration))
                    .catch(error => console.log('Pendaftaran Service Worker gagal:', error));
            }
        }
        
        function showUpdateNotification() {
            if (dom.updateNotification) {
                dom.updateNotification.classList.remove(CLASS_NAMES.HIDDEN);
                setTimeout(() => {
                    dom.updateNotification.classList.add(CLASS_NAMES.HIDDEN);
                }, 4000);
            }
        }

        function listenForServiceWorkerUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'CACHE_UPDATED') {
                        console.log('Menerima pesan update dari Service Worker.');
                        showUpdateNotification();
                    }
                });
            }
        }

        // --- Inisialisasi Event Listeners ---
        function setupEventListeners() {
            const stage = dom.sliderStage;
            stage.addEventListener('touchstart', handleTouchStart, { passive: false });
            stage.addEventListener('touchmove', handleTouchMove, { passive: false });
            stage.addEventListener('touchend', handleTouchEnd);
            window.addEventListener('resize', debounce(updateSlideDimensions, 250));
            
            dom.settingsTrigger.addEventListener('click', openSettings);
            dom.closeSettingsBtn.addEventListener('click', closeSettings);
            dom.saveSettingsBtn.addEventListener('click', saveSettings);

            dom.modeOnlineBtn.addEventListener('click', () => toggleMode('online'));
            dom.modeManualBtn.addEventListener('click', () => toggleMode('manual'));

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSettings();
            });
        }
        
        // --- Inisialisasi Aplikasi ---
        function init() {
            loadSettings();
            setupEventListeners();
            updateSlideDimensions();
            registerServiceWorker();
            listenForServiceWorkerUpdates();
        }

        init();
    </script>
</body>
</html>